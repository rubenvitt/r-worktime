# Story 2.3: Import-Preview

## Status
**Draft**

## Story
**Als ein** Nutzer mit bestehenden Zeitdaten,  
**möchte ich** vor dem Import eine Vorschau der betroffenen Tage sehen,  
**damit** ich versehentliche Überschreibungen vermeiden und bewusste Entscheidungen treffen kann.

## Acceptance Criteria

1. Nach Upload einer JSON-Datei wird eine Vorschau angezeigt
2. Auflistung aller betroffenen Tage im Import
3. Markierung von Tagen, die überschrieben werden (mit vorher/nachher Vergleich)
4. Warnung bei ungewöhnlichen Einträgen (z.B. Wochenende, Feiertage, sehr lange Arbeitszeiten)
5. Anzeige der Anzahl neuer vs. zu ersetzender Einträge
6. Statistik-Übersicht (Gesamtstunden, Durchschnitt, etc.)
7. Bestätigungs-Button für Import-Durchführung
8. Abbruch-Option ohne Datenänderung
9. Detailansicht für einzelne Tage möglich
10. Fehlerhafte Einträge werden hervorgehoben mit Erklärung

## Tasks / Subtasks

- [ ] **Backend Preview-Logik** (AC: 1,2,3,4,5,6,10)
  - [ ] POST /api/entries/preview Endpoint erstellen
  - [ ] JSON-Parsing ohne Speicherung
  - [ ] Konflikt-Erkennung implementieren
  - [ ] Validierung und Warnungen generieren
  - [ ] Statistik-Berechnung für Preview
  
- [ ] **Frontend Preview-Komponente** (AC: 1,2,3,4,5,6,7,8,9,10)
  - [ ] ImportPreview Modal/Page erstellen
  - [ ] Tages-Liste mit Vergleichsansicht
  - [ ] Warnung-Komponenten implementieren
  - [ ] Statistik-Dashboard für Import
  - [ ] Confirm/Cancel Actions
  
- [ ] **Import-Flow Integration** (AC: 1,7,8)
  - [ ] Upload-Flow mit Preview verbinden
  - [ ] Zwei-Schritt-Import implementieren
  - [ ] State-Management für Preview-Daten
  - [ ] Error-Recovery bei Import-Fehler

## Dev Notes

### Story Context

**Existing System Integration:**
- Integrates with: File-Upload System, JSON-Parser, TimeEntry Service
- Technology: Next.js 15, React 19, TanStack Query, Tailwind CSS
- Follows pattern: Bestehende Upload-Flow und Modal-Pattern
- Touch points:
  - Upload-Interface (FR-1.1)
  - Datenverarbeitung (FR-1.2)
  - TimeEntry Model
  - Dashboard für Navigation zurück

### Technical Implementation Details

**Backend Implementation:**
- Preview-Endpoint arbeitet stateless (keine DB-Änderungen)
- Temporäre Speicherung der Preview-Daten in Memory/Redis
- Session-basierte Preview-ID für Zwei-Schritt-Import

**Preview Response Structure:**
```typescript
{
  previewId: string // für späteren Import
  summary: {
    totalEntries: number
    newEntries: number
    replacedEntries: number
    affectedDays: number
    totalHours: number
    dateRange: { from: Date, to: Date }
  }
  warnings: Array<{
    type: 'WEEKEND' | 'HOLIDAY' | 'LONG_HOURS' | 'DUPLICATE' | 'INVALID'
    date: Date
    message: string
    severity: 'info' | 'warning' | 'error'
  }>
  entries: Array<{
    date: Date
    existing?: TimeEntry[]
    new: TimeEntry[]
    action: 'CREATE' | 'REPLACE' | 'SKIP'
    conflicts: string[]
  }>
  validation: {
    isValid: boolean
    errors: string[]
  }
}
```

**Frontend Architecture:**
- Komponenten:
  - `ImportPreview.tsx` - Hauptcontainer
  - `PreviewSummary.tsx` - Statistik-Übersicht
  - `PreviewDayList.tsx` - Liste betroffener Tage
  - `DayComparison.tsx` - Vorher/Nachher Vergleich
  - `WarningBanner.tsx` - Warnungen anzeigen
  - `ImportActions.tsx` - Confirm/Cancel Buttons
- Modal oder Full-Page Preview (je nach Datenmenge)
- Pagination bei vielen Einträgen

**Validation & Warnings:**
- Wochenend-Arbeit (Samstag/Sonntag)
- Überlange Arbeitszeiten (> 10h/Tag)
- Fehlende Pausen bei langen Tagen
- Duplikate im gleichen Zeitraum
- Ungültige Zeitformate
- Negative Zeiten
- Überlappende Zeiträume

**Import-Flow:**
1. User uploaded JSON
2. Backend parsed und generiert Preview
3. Frontend zeigt Preview mit Warnungen
4. User kann Details prüfen
5. User bestätigt oder bricht ab
6. Bei Bestätigung: Import mit previewId
7. Success-Feedback und Dashboard-Update

**Key Constraints:**
- Preview-Daten max. 15 Minuten gültig
- Große Imports (>1000 Einträge) mit Pagination
- Memory-effiziente Verarbeitung

### Testing Standards

**Testing Requirements:**
- Unit Tests für:
  - Preview-Generation Logic
  - Konflikt-Erkennung
  - Validierungs-Regeln
- Integration Tests für:
  - Upload-to-Preview Flow
  - Preview-to-Import Flow
  - Warning-Generation
- E2E Tests für:
  - Kompletter Import-Flow mit Preview
  - Abbruch-Szenario
  - Error-Handling
- Testing Frameworks: Jest, React Testing Library
- Test-Daten mit verschiedenen Edge-Cases

## Change Log

| Date | Version | Description | Author |
|------|---------|------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*To be filled by QA agent*

---

## Definition of Done

- [ ] Functional requirements met (alle AC erfüllt)
- [ ] Preview zeigt alle relevanten Informationen
- [ ] Warnungen werden korrekt generiert
- [ ] Import kann abgebrochen werden ohne Datenänderung
- [ ] Zwei-Schritt-Import funktioniert zuverlässig
- [ ] Tests pass mit mindestens 70% Coverage
- [ ] Performance akzeptabel auch bei großen Dateien
- [ ] Documentation updated
- [ ] Code Review durchgeführt

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Versehentliches Überschreiben wichtiger Daten
- **Mitigation:** Klare Vorschau mit Warnungen, explizite Bestätigung erforderlich, Backup vor Import möglich
- **Rollback:** Import-History mit Undo-Option (future feature)

**Compatibility Verification:**
- [x] No breaking changes to existing Upload-API
- [x] Erweitert bestehenden Import-Flow
- [x] UI changes follow existing design patterns
- [x] Performance durch Preview nicht beeinträchtigt

## Implementation Priority
**High** - Critical für Datenintegrität und User-Vertrauen. Verhindert Datenverlust und verbessert UX erheblich.