# Story 2.4: Daten-Management

## Status
**Ready for Review**

## Story
**Als ein** angemeldeter Nutzer,  
**möchte ich** meine gespeicherten Zeiteinträge verwalten können,  
**damit** ich fehlerhafte Daten korrigieren und meine Zeiterfassung sauber halten kann.

## Acceptance Criteria

1. Anzeige aller gespeicherten Zeiteinträge in einer Listenansicht
2. Einzelne Zeiteinträge können gelöscht werden
3. Zeiträume können ausgewählt und gelöscht werden (z.B. ganze Woche/Monat)
4. Export der eigenen Daten in verschiedenen Formaten (JSON, CSV)
5. Backup-Funktion für alle Daten
6. Restore-Funktion für Backups
7. Filterung nach Datum, Typ (Arbeit/Urlaub/Krankheit), Projekt
8. Sortierung nach verschiedenen Kriterien
9. Pagination für große Datenmengen
10. Bestätigung vor destruktiven Aktionen (Löschen, Restore)

## Tasks / Subtasks

- [x] **Backend Data-Management API** (AC: 1,2,3,4,5,6,7,8,9)
  - [x] GET /api/time-entries mit erweiterten Filter-Optionen (Datum, Typ, Projekt, Suche)
  - [x] DELETE /api/time-entries/[id] für Einzellöschung (bereits vorhanden)
  - [x] DELETE /api/time-entries/bulk für Mehrfachlöschung mit Safeguards
  - [x] GET /api/time-entries/export mit Format-Parameter (JSON/CSV/Excel)
  - [x] POST /api/backup/create für Backup-Erstellung
  - [x] POST /api/backup/restore für Wiederherstellung mit Vorschau
  
- [x] **Frontend Data-Management UI** (AC: 1,2,3,7,8,9,10)
  - [x] DataManagement Page/Component erstellen (/dashboard/data)
  - [x] TanStack Table mit Sorting, Filtering, Pagination, Selection
  - [x] Filter- und Sortier-Controls (Datum, Typ, Suche)
  - [x] Bulk-Selection implementieren mit Aktionen
  - [x] Lösch-Dialoge mit Bestätigungen und Progress
  
- [x] **Export & Backup Features** (AC: 4,5,6,10)
  - [x] Export-Dialog mit Format-Auswahl (JSON/CSV/Excel)
  - [x] Download-Funktionalität mit Progress-Anzeige
  - [x] Backup-Management Interface mit Statistiken
  - [x] Restore-Dialog mit Vorschau und Optionen

## Dev Notes

### Story Context

**Existing System Integration:**
- Integrates with: TimeEntry Service, Authentication, File-System
- Technology: Next.js 15, React Table/TanStack Table, Prisma ORM
- Follows pattern: CRUD-Operations, Bestehende Table-Components
- Touch points:
  - TimeEntry Model und Service
  - Authentication Middleware
  - Dashboard für Navigation
  - Import-System (für Restore)

### Technical Implementation Details

**Backend Implementation:**
- Erweiterte Query-Options für Filtering/Sorting
- Soft-Delete Option für Recovery (optional)
- Transactional Bulk-Operations
- Streaming für große Exports

**API Endpoints Detail:**
```typescript
// GET /api/entries - Erweiterte Liste
Query params: {
  page?: number
  limit?: number
  sortBy?: 'date' | 'duration' | 'type'
  sortOrder?: 'asc' | 'desc'
  dateFrom?: string
  dateTo?: string
  type?: 'WORK' | 'VACATION' | 'SICK' | 'HOLIDAY'
  projectName?: string
  searchTerm?: string
}

// DELETE /api/entries/bulk
Body: {
  ids?: string[] // specific IDs
  dateRange?: { from: Date, to: Date }
  filters?: QueryParams // same as GET
}

// GET /api/entries/export
Query params: {
  format: 'json' | 'csv' | 'excel'
  dateFrom?: string
  dateTo?: string
  includeSettings?: boolean
}

// Backup Structure
{
  version: string
  exportDate: Date
  userData: {
    settings: UserSettings
    entries: TimeEntry[]
    statistics: Summary
  }
}
```

**Frontend Architecture:**
- Route: `/dashboard/data` oder `/dashboard/manage`
- Komponenten:
  - `DataManagement.tsx` - Hauptcontainer
  - `EntriesTable.tsx` - Tabellen-Komponente (TanStack Table)
  - `FilterBar.tsx` - Filter-Controls
  - `BulkActions.tsx` - Mehrfach-Aktionen
  - `ExportDialog.tsx` - Export-Optionen
  - `BackupManager.tsx` - Backup/Restore UI
  - `DeleteConfirmation.tsx` - Lösch-Bestätigung
- State Management:
  - Selection State für Bulk-Operations
  - Filter/Sort State in URL Parameters
  - Optimistic Updates bei Löschungen

**Table Features:**
- Column Sorting
- Row Selection (Checkbox)
- Inline Actions (Delete, Edit)
- Responsive Design (Mobile: Card-View)
- Virtual Scrolling für Performance
- Search/Filter in Echtzeit

**Export Formats:**
```typescript
// JSON Format (Original Timing-kompatibel)
[{
  date: string
  startTime: string
  endTime: string
  duration: number
  type: string
  projectName?: string
  description?: string
}]

// CSV Format
"Date","Start","End","Duration","Type","Project","Description"
"2025-01-12","09:00","17:30","8.5","WORK","Project A","Development"

// Excel: Similar to CSV with formatting
```

**Data Safety:**
- Bestätigungs-Dialoge für alle Löschungen
- Undo-Option für kürzliche Löschungen (5 Min)
- Backup vor Bulk-Operations
- Audit-Log für wichtige Aktionen

**Key Constraints:**
- Max Export-Größe: 50MB
- Bulk-Delete max: 1000 Einträge
- Backup-Retention: 30 Tage
- Rate-Limiting für Export-API

### Testing Standards

**Testing Requirements:**
- Unit Tests für:
  - Filter/Sort Logic
  - Export-Formatierung
  - Backup/Restore Logic
- Integration Tests für:
  - Bulk-Operations
  - Export-Download
  - Filter-Kombinationen
- E2E Tests für:
  - Kompletter Data-Management Flow
  - Export und Re-Import
  - Backup und Restore
- Performance Tests für große Datenmengen
- Testing Frameworks: Jest, React Testing Library

## Change Log

| Date | Version | Description | Author |
|------|---------|------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
**Claude Sonnet 4** - James (Expert Senior Software Engineer)

### Debug Log References
- Fixed runtime error: duration.toFixed TypeError - Handled Prisma Decimal type properly
- Navigation integration: Added /data link to dashboard layout
- Type safety: Updated interfaces to handle Prisma Decimal vs number types

### Completion Notes List
- **Backend APIs**: 5 neue API-Endpoints erstellt mit vollständiger Fehlerbehandlung
- **Frontend UI**: Umfassende Data Management Page mit TanStack Table
- **Export System**: JSON/CSV/Excel Export mit Timing-Kompatibilität
- **Backup System**: Vollständige Backup/Restore Funktionalität mit Vorschau
- **Security**: Rate Limiting, Bulk-Operation Limits, User-Auth überall
- **UX**: Progress-Anzeigen, Bestätigungs-Dialoge, detaillierte Fehlermeldungen

### File List
**Backend APIs:**
- `src/app/api/time-entries/route.ts` - Extended with advanced filtering/sorting
- `src/app/api/time-entries/bulk/route.ts` - NEW: Bulk delete with preview
- `src/app/api/time-entries/export/route.ts` - NEW: Multi-format export
- `src/app/api/backup/create/route.ts` - NEW: Backup creation
- `src/app/api/backup/restore/route.ts` - NEW: Backup restore with preview

**Frontend Components:**
- `src/app/(dashboard)/data/page.tsx` - NEW: Main data management page
- `src/components/data/data-table.tsx` - NEW: Advanced TanStack Table component
- `src/components/data/export-dialog.tsx` - NEW: Export dialog with format selection
- `src/components/data/bulk-delete-dialog.tsx` - NEW: Bulk delete with confirmation
- `src/components/data/backup-manager.tsx` - NEW: Backup/restore management

**Navigation:**
- `src/app/(dashboard)/layout.tsx` - Added data management navigation link

**Dependencies Added:**
- `@tanstack/react-table@8.21.3` - Advanced table functionality
- `date-fns` - Date formatting and manipulation

## QA Results
*To be filled by QA agent*

---

## Definition of Done

- [ ] Functional requirements met (alle AC erfüllt)
- [ ] CRUD-Operations für TimeEntries funktionieren
- [ ] Export in allen Formaten möglich
- [ ] Backup/Restore zuverlässig
- [ ] Filter und Sortierung performant
- [ ] Bulk-Operations mit Safeguards
- [ ] Tests pass mit mindestens 70% Coverage
- [ ] Responsive Design implementiert
- [ ] Documentation updated
- [ ] Code Review durchgeführt

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Versehentlicher Datenverlust durch Löschungen
- **Mitigation:** Bestätigungs-Dialoge, Undo-Option, automatische Backups vor Bulk-Operations
- **Rollback:** Backup-Restore Funktion, Soft-Delete Option

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Erweitert bestehende Endpoints
- [x] Export-Format kompatibel mit Timing
- [x] Performance durch Pagination gesichert

## Implementation Priority
**Medium-High** - Wichtig für Datenintegrität und User-Kontrolle, aber nicht kritisch für Grundfunktionalität. Ermöglicht Fehlerkorrektur und Datenpflege.