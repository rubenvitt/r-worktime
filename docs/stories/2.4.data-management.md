# Story 2.4: Daten-Management

## Status
**Draft**

## Story
**Als ein** angemeldeter Nutzer,  
**möchte ich** meine gespeicherten Zeiteinträge verwalten können,  
**damit** ich fehlerhafte Daten korrigieren und meine Zeiterfassung sauber halten kann.

## Acceptance Criteria

1. Anzeige aller gespeicherten Zeiteinträge in einer Listenansicht
2. Einzelne Zeiteinträge können gelöscht werden
3. Zeiträume können ausgewählt und gelöscht werden (z.B. ganze Woche/Monat)
4. Export der eigenen Daten in verschiedenen Formaten (JSON, CSV)
5. Backup-Funktion für alle Daten
6. Restore-Funktion für Backups
7. Filterung nach Datum, Typ (Arbeit/Urlaub/Krankheit), Projekt
8. Sortierung nach verschiedenen Kriterien
9. Pagination für große Datenmengen
10. Bestätigung vor destruktiven Aktionen (Löschen, Restore)

## Tasks / Subtasks

- [ ] **Backend Data-Management API** (AC: 1,2,3,4,5,6,7,8,9)
  - [ ] GET /api/entries mit erweiterten Filter-Optionen
  - [ ] DELETE /api/entries/:id für Einzellöschung
  - [ ] DELETE /api/entries/bulk für Mehrfachlöschung
  - [ ] GET /api/entries/export mit Format-Parameter
  - [ ] POST /api/backup/create für Backup-Erstellung
  - [ ] POST /api/backup/restore für Wiederherstellung
  
- [ ] **Frontend Data-Management UI** (AC: 1,2,3,7,8,9,10)
  - [ ] DataManagement Page/Component erstellen
  - [ ] Entries-Tabelle mit Aktionen
  - [ ] Filter- und Sortier-Controls
  - [ ] Bulk-Selection implementieren
  - [ ] Lösch-Dialoge mit Bestätigung
  
- [ ] **Export & Backup Features** (AC: 4,5,6,10)
  - [ ] Export-Dialog mit Format-Auswahl
  - [ ] Download-Funktionalität
  - [ ] Backup-Management Interface
  - [ ] Restore-Dialog mit Vorschau

## Dev Notes

### Story Context

**Existing System Integration:**
- Integrates with: TimeEntry Service, Authentication, File-System
- Technology: Next.js 15, React Table/TanStack Table, Prisma ORM
- Follows pattern: CRUD-Operations, Bestehende Table-Components
- Touch points:
  - TimeEntry Model und Service
  - Authentication Middleware
  - Dashboard für Navigation
  - Import-System (für Restore)

### Technical Implementation Details

**Backend Implementation:**
- Erweiterte Query-Options für Filtering/Sorting
- Soft-Delete Option für Recovery (optional)
- Transactional Bulk-Operations
- Streaming für große Exports

**API Endpoints Detail:**
```typescript
// GET /api/entries - Erweiterte Liste
Query params: {
  page?: number
  limit?: number
  sortBy?: 'date' | 'duration' | 'type'
  sortOrder?: 'asc' | 'desc'
  dateFrom?: string
  dateTo?: string
  type?: 'WORK' | 'VACATION' | 'SICK' | 'HOLIDAY'
  projectName?: string
  searchTerm?: string
}

// DELETE /api/entries/bulk
Body: {
  ids?: string[] // specific IDs
  dateRange?: { from: Date, to: Date }
  filters?: QueryParams // same as GET
}

// GET /api/entries/export
Query params: {
  format: 'json' | 'csv' | 'excel'
  dateFrom?: string
  dateTo?: string
  includeSettings?: boolean
}

// Backup Structure
{
  version: string
  exportDate: Date
  userData: {
    settings: UserSettings
    entries: TimeEntry[]
    statistics: Summary
  }
}
```

**Frontend Architecture:**
- Route: `/dashboard/data` oder `/dashboard/manage`
- Komponenten:
  - `DataManagement.tsx` - Hauptcontainer
  - `EntriesTable.tsx` - Tabellen-Komponente (TanStack Table)
  - `FilterBar.tsx` - Filter-Controls
  - `BulkActions.tsx` - Mehrfach-Aktionen
  - `ExportDialog.tsx` - Export-Optionen
  - `BackupManager.tsx` - Backup/Restore UI
  - `DeleteConfirmation.tsx` - Lösch-Bestätigung
- State Management:
  - Selection State für Bulk-Operations
  - Filter/Sort State in URL Parameters
  - Optimistic Updates bei Löschungen

**Table Features:**
- Column Sorting
- Row Selection (Checkbox)
- Inline Actions (Delete, Edit)
- Responsive Design (Mobile: Card-View)
- Virtual Scrolling für Performance
- Search/Filter in Echtzeit

**Export Formats:**
```typescript
// JSON Format (Original Timing-kompatibel)
[{
  date: string
  startTime: string
  endTime: string
  duration: number
  type: string
  projectName?: string
  description?: string
}]

// CSV Format
"Date","Start","End","Duration","Type","Project","Description"
"2025-01-12","09:00","17:30","8.5","WORK","Project A","Development"

// Excel: Similar to CSV with formatting
```

**Data Safety:**
- Bestätigungs-Dialoge für alle Löschungen
- Undo-Option für kürzliche Löschungen (5 Min)
- Backup vor Bulk-Operations
- Audit-Log für wichtige Aktionen

**Key Constraints:**
- Max Export-Größe: 50MB
- Bulk-Delete max: 1000 Einträge
- Backup-Retention: 30 Tage
- Rate-Limiting für Export-API

### Testing Standards

**Testing Requirements:**
- Unit Tests für:
  - Filter/Sort Logic
  - Export-Formatierung
  - Backup/Restore Logic
- Integration Tests für:
  - Bulk-Operations
  - Export-Download
  - Filter-Kombinationen
- E2E Tests für:
  - Kompletter Data-Management Flow
  - Export und Re-Import
  - Backup und Restore
- Performance Tests für große Datenmengen
- Testing Frameworks: Jest, React Testing Library

## Change Log

| Date | Version | Description | Author |
|------|---------|------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*To be filled by QA agent*

---

## Definition of Done

- [ ] Functional requirements met (alle AC erfüllt)
- [ ] CRUD-Operations für TimeEntries funktionieren
- [ ] Export in allen Formaten möglich
- [ ] Backup/Restore zuverlässig
- [ ] Filter und Sortierung performant
- [ ] Bulk-Operations mit Safeguards
- [ ] Tests pass mit mindestens 70% Coverage
- [ ] Responsive Design implementiert
- [ ] Documentation updated
- [ ] Code Review durchgeführt

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Versehentlicher Datenverlust durch Löschungen
- **Mitigation:** Bestätigungs-Dialoge, Undo-Option, automatische Backups vor Bulk-Operations
- **Rollback:** Backup-Restore Funktion, Soft-Delete Option

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Erweitert bestehende Endpoints
- [x] Export-Format kompatibel mit Timing
- [x] Performance durch Pagination gesichert

## Implementation Priority
**Medium-High** - Wichtig für Datenintegrität und User-Kontrolle, aber nicht kritisch für Grundfunktionalität. Ermöglicht Fehlerkorrektur und Datenpflege.