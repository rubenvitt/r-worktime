# Story 1.3: Overtime Calculation Engine

## Status
Draft

## Story
**As a** user,  
**I want** the system to automatically calculate my overtime/undertime hours,  
**so that** I always know my current hour balance without manual calculations

## Acceptance Criteria

1. System calculates difference between actual hours and target hours per day
2. Special time types (vacation, sick leave) are recognized and handled correctly
3. Calculations accumulate over all available time periods
4. Precision is maintained at 0.25 hour intervals (15 minutes)
5. Weekend work is calculated as pure overtime
6. Public holidays are considered with configurable rules
7. Running total is updated after each data import
8. Calculations can be recalculated from scratch if needed

## Tasks / Subtasks

- [ ] Create calculation engine core (AC: 1)
  - [ ] Implement daily balance calculation (actual - target)
  - [ ] Create weekly and monthly aggregation logic
  - [ ] Build cumulative balance calculator
  
- [ ] Implement special time handling (AC: 2)
  - [ ] Define special time type enum (vacation, sick, holiday)
  - [ ] Create rules for each special time type
  - [ ] Implement special time detection from import data
  
- [ ] Build accumulation system (AC: 3)
  - [ ] Create period-based accumulation logic
  - [ ] Implement balance carry-over between periods
  - [ ] Add historical balance tracking
  
- [ ] Ensure precision handling (AC: 4)
  - [ ] Implement 15-minute rounding logic
  - [ ] Create decimal to time format converters
  - [ ] Add precision validation in calculations
  
- [ ] Handle weekend overtime (AC: 5)
  - [ ] Detect weekend days (Saturday, Sunday)
  - [ ] Apply 100% overtime rate for weekends
  - [ ] Create weekend work reports
  
- [ ] Implement holiday logic (AC: 6)
  - [ ] Create holiday configuration table
  - [ ] Load public holidays by region/year
  - [ ] Apply holiday rules to calculations
  
- [ ] Create update triggers (AC: 7)
  - [ ] Trigger recalculation on new import
  - [ ] Update running totals incrementally
  - [ ] Implement calculation queue system
  
- [ ] Build recalculation feature (AC: 8)
  - [ ] Create full recalculation endpoint
  - [ ] Implement calculation audit trail
  - [ ] Add calculation versioning

## Dev Notes

### Technology Stack (from Architecture)
- **Calculation Engine**: TypeScript service layer
- **Database**: PostgreSQL for persistence
- **Queue**: Bull queue for async calculations
- **Cache**: Redis for calculation results

### Calculation Formula
```typescript
// Daily balance
dailyBalance = actualHours - targetHours

// Target hours per day (configurable)
targetHours = 8.0 // default

// Special time handling
if (isVacation || isSickLeave) {
  dailyBalance = 0 // No overtime/undertime
}

// Weekend handling
if (isWeekend) {
  dailyBalance = actualHours // All hours are overtime
}

// Rounding to 0.25 intervals
roundedHours = Math.round(hours * 4) / 4
```

### Database Schema Extensions
```sql
-- overtime_calculations table
id: UUID
user_id: UUID
date: DATE
actual_hours: DECIMAL(4,2)
target_hours: DECIMAL(4,2)
balance_hours: DECIMAL(4,2)
cumulative_balance: DECIMAL(6,2)
is_weekend: BOOLEAN
is_holiday: BOOLEAN
special_time_type: VARCHAR(50)
calculation_version: INTEGER
calculated_at: TIMESTAMP

-- holidays table
id: UUID
date: DATE
name: VARCHAR(255)
region: VARCHAR(50)
type: VARCHAR(50) -- public, regional, optional
```

### Service Structure
- `/src/services/overtimeCalculationService.ts`
- `/src/calculators/dailyBalanceCalculator.ts`
- `/src/calculators/cumulativeBalanceCalculator.ts`
- `/src/utils/timeRounding.ts`
- `/src/config/holidayConfig.ts`

### API Endpoints
- `GET /api/overtime/balance` - Current balance
- `GET /api/overtime/history` - Historical calculations
- `POST /api/overtime/recalculate` - Trigger full recalculation

### Testing
- **Test Location**: `/src/__tests__/calculators/`
- **Framework**: Jest
- **Test Cases Required**:
  - Normal day calculation
  - Weekend overtime
  - Holiday handling
  - Special time types
  - Rounding precision
  - Cumulative calculations
  - Edge cases (year boundaries, etc.)

### Configuration
Default work week configuration (configurable per user):
- Monday-Friday: 8 hours/day
- Saturday-Sunday: 0 hours (overtime)
- Total weekly target: 40 hours

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-11 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled during development_

### Completion Notes List
_To be filled during development_

### File List
_To be filled during development_

## QA Results
_To be filled by QA agent_