# Story 2.2: Benutzer-Konfiguration

## Status
**Draft**

## Story
**Als ein** angemeldeter Nutzer,  
**möchte ich** meine persönlichen Arbeitszeit-Einstellungen konfigurieren,  
**damit** die Überstundenberechnung exakt auf meine Arbeitssituation angepasst ist.

## Acceptance Criteria

1. Konfiguration der wöchentlichen Soll-Arbeitszeit (z.B. 40 Stunden)
2. Auswahl der Arbeitstage (Mo-Fr, Mo-Sa, etc.)
3. Definition von Standard-Arbeitszeiten (Start/Ende)
4. Timezone-Einstellung für korrekte Zeitberechnung
5. Einstellungen werden persistent in der Datenbank gespeichert
6. Änderungen werden sofort in allen Berechnungen berücksichtigt
7. Validierung der Eingaben (z.B. max. 168 Stunden/Woche)
8. Vorschau der Auswirkungen auf Überstundenberechnung
9. Reset auf Standard-Werte möglich
10. Responsive Formular-Design für alle Geräte

## Tasks / Subtasks

- [ ] **Backend API für Settings** (AC: 1,2,3,4,5,6,7)
  - [ ] UserSettings Model erweitern/erstellen
  - [ ] GET /api/settings Endpoint implementieren
  - [ ] PUT /api/settings Endpoint implementieren
  - [ ] Validierung der Eingabewerte
  - [ ] Migration für UserSettings Tabelle
  
- [ ] **Frontend Settings-Komponente** (AC: 1,2,3,4,8,9,10)
  - [ ] Settings-Formular mit React Hook Form erstellen
  - [ ] Arbeitstage-Selector implementieren
  - [ ] Zeit-Input-Komponenten für Start/Ende
  - [ ] Timezone-Dropdown implementieren
  - [ ] Vorschau-Berechnung anzeigen
  
- [ ] **Integration in Berechnungslogik** (AC: 6,8)
  - [ ] Overtime-Calculation mit User-Settings verbinden
  - [ ] Dashboard-Anzeige aktualisieren
  - [ ] Wochenansicht mit Settings verknüpfen
  - [ ] Cache-Invalidierung bei Settings-Änderung

## Dev Notes

### Story Context

**Existing System Integration:**
- Integrates with: User-Model, Overtime-Calculation-Engine, Dashboard
- Technology: Next.js 15, React Hook Form, Zod Validation, Prisma ORM
- Follows pattern: Bestehende Form-Patterns und Validation-Struktur
- Touch points:
  - User Authentication System
  - Overtime Calculation Service
  - Dashboard & Week View Components
  - Database Schema (User, UserSettings)

### Technical Implementation Details

**Backend Implementation:**
- Erweitere Prisma Schema um UserSettings Model
- One-to-One Relation mit User Model
- Default-Werte bei User-Registrierung setzen
- Settings-Cache für Performance

**UserSettings Schema:**
```typescript
{
  id: string (CUID)
  userId: string (FK zu User)
  weeklyHours: number (default: 40)
  workDays: number[] (default: [1,2,3,4,5])
  defaultStartTime: string (default: "09:00")
  defaultEndTime: string (default: "17:00")
  timezone: string (default: "Europe/Berlin")
  breakDuration: number (default: 0.5) // in hours
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Frontend Architecture:**
- Route: `/dashboard/settings` oder Modal im Dashboard
- Komponenten:
  - `UserSettings.tsx` - Hauptformular
  - `WorkDaysSelector.tsx` - Arbeitstage-Auswahl
  - `TimeInput.tsx` - Zeit-Eingabe-Komponente
  - `SettingsPreview.tsx` - Vorschau der Auswirkungen
- Form Validation mit Zod Schema
- Optimistic Updates für bessere UX

**Validation Rules:**
- weeklyHours: min 1, max 168
- workDays: mindestens 1 Tag ausgewählt
- startTime < endTime
- timezone: gültige IANA Timezone

**Key Constraints:**
- Settings-Änderungen dürfen historische Daten nicht verändern
- Nur zukünftige Berechnungen betroffen
- Migration muss Default-Werte für bestehende User setzen

### Testing Standards

**Testing Requirements:**
- Unit Tests für:
  - Settings Validation Logic
  - API Endpoints
  - Form Components
- Integration Tests für:
  - Settings-Update Flow
  - Auswirkung auf Berechnungen
  - Cache-Invalidierung
- E2E Tests für:
  - Kompletter Settings-Flow
  - Validierungs-Feedback
- Testing Frameworks: Jest, React Testing Library
- Minimum Coverage: 70% für neue Code

## Change Log

| Date | Version | Description | Author |
|------|---------|------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*To be filled by QA agent*

---

## Definition of Done

- [ ] Functional requirements met (alle AC erfüllt)
- [ ] UserSettings Model in Datenbank implementiert
- [ ] Settings-API vollständig funktionsfähig
- [ ] Form-Validierung client- und serverseitig
- [ ] Integration mit Berechnungslogik verifiziert
- [ ] Tests pass (existing and new) mit mindestens 70% Coverage
- [ ] Migration erfolgreich durchgeführt
- [ ] Documentation updated
- [ ] Code Review durchgeführt

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Settings-Änderungen könnten historische Berechnungen beeinflussen
- **Mitigation:** Klare Trennung zwischen historischen und zukünftigen Berechnungen, Settings gelten nur für neue Einträge
- **Rollback:** Settings auf Default-Werte zurücksetzen möglich

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Database migration ist additiv (neue Tabelle)
- [x] UI changes follow existing design patterns
- [x] Performance impact minimal durch Caching

## Implementation Priority
**High** - Essential Feature für korrekte, personalisierte Überstundenberechnung. Voraussetzung für viele weitere Features.